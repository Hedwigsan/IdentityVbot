# キャラアイコン画像認識ガイド（必須）

## ⚠️ 重要な変更

画面に表示されているのは：
- ❌ **プレイヤー名**（ヘドウィグさん、花香芽矢など）← これはユーザー名
- ✅ **キャラアイコン**（左側の画像）← これが実際のサバイバーキャラ

テキストOCRでは**プレイヤー名**しか読めないため、**キャラアイコンの画像認識が必須**です。

## セットアップ（必須）

### 方法1: 自動切り出しツール（推奨）

```bash
# 1. 戦績画面のスクショを用意
# 2. ツールを実行
python extract_icons.py screenshot.png

# 3. 画面の指示に従ってアイコンをクリック
#    - 左上をクリック
#    - 右下をクリック
#    - キャラ名を入力
# 4. 'q'で終了
```

このツールが自動で `templates/icons/` にアイコン画像を保存します。

### 方法2: 手動で切り出し

1. **templatesディレクトリを作成**
```bash
mkdir -p templates/icons
```

2. **画像編集ソフトでアイコンを切り出し**
   - 戦績画面のスクショを開く
   - 各キャラのアイコン部分（左側の画像）を切り出し
   - サイズを統一（推奨: 70x70 または 80x80 ピクセル）
   - PNG形式で保存

3. **ファイル名規則**
```
templates/icons/
├── 医師.png
├── 庭師.png
├── 機械技師.png
├── 傭兵.png
├── 祭司.png
└── ...
```

**ファイル名 = キャラクター名**（拡張子を除く）

## 推奨するアイコン画像の仕様

```
形式: PNG
サイズ: 70x70 または 80x80 px
背景: ゲーム画面そのまま
品質: できるだけ鮮明
```

## 画像の切り出し位置

あなたがアップロードした画像から判断すると：

```
┌────────────────────────────────────────┐
│  [📷]  ヘドウィグさん ⭕️ 2  3  25  -  5│
│   ↑                                    │
│ このアイコン部分を切り出す               │
└────────────────────────────────────────┘

座標（おおよそ）:
- X: 60~140px（左から）
- Y: 各サバイバーの行（4行）
- サイズ: 約70x70px または 80x80px
```

## 必要なキャラクター数

最低限、**よく対戦するキャラ**だけでもOKです：

**優先度高:**
- 医師
- 機械技師
- 傭兵
- 祭司
- 占い師
- 調香師

全キャラ登録すれば完璧ですが、まずは主要キャラから始めましょう。

## 動作確認

Botを起動すると：

```
✅ 35個のキャラアイコンを読み込みました
```

このようなメッセージが表示されます。

アイコンがない場合：

```
⚠️  templates/icons/ ディレクトリが見つかりません
キャラアイコン画像を追加してください。詳細: ICON_GUIDE.md
```

## 画像認識の仕組み

```python
# 1. アイコンの位置を推定
icon_positions = [
    (60, 250),  # サバイバー1
    (60, 350),  # サバイバー2
    (60, 450),  # サバイバー3
    (60, 550),  # サバイバー4
]

# 2. 各位置でテンプレートマッチング
for template_name, template_img in templates:
    similarity = cv2.matchTemplate(icon, template_img)
    if similarity > 0.65:  # 65%以上一致
        character = template_name
```

## テンプレート画像の例

実際の戦績画面から切り出した例：

```
医師.png:
┌──────┐
│ 👨‍⚕️  │ 
│      │
└──────┘
70x70px

機械技師.png:
┌──────┐
│ 👷‍♀️  │
│      │
└──────┘
70x70px
```

## トラブルシューティング

### アイコンが認識されない

**原因1: テンプレート画像が少ない**
→ もっと多くのキャラを登録

**原因2: 画像のサイズが合っていない**
→ 70x70pxまたは80x80pxに統一

**原因3: ゲーム画面の解像度が異なる**
→ 同じ解像度のスクショから切り出す

**原因4: アイコンの切り出し位置が違う**
→ 左側のキャラアイコン部分を正確に切り出す

### 認識精度を上げる方法

1. **複数の状態で撮影**
   - 勝利画面
   - 敗北画面
   - データ画面（タブ切り替え後）

2. **閾値を調整**
   ```python
   # ocr_processor.py の254行目
   best_score = 0.60  # 60%以上で認識（緩和）
   best_score = 0.70  # 70%以上で認識（厳格）
   ```

3. **解像度を統一**
   - 常に同じ解像度でスクショを撮る
   - テンプレートもその解像度で切り出す

## よくある質問

### Q: 全キャラ分のアイコンが必要？
A: いいえ。よく対戦するキャラだけでOKです。認識できないキャラがいても、他のデータ（牽制時間など）は記録されます。

### Q: テンプレート画像はどこから入手？
A: 自分の戦績画面から切り出すのが一番確実です。公式サイトやWikiの画像は角度や装飾が違う可能性があります。

### Q: 画像認識なしでは使えない？
A: はい、キャラ名の認識には画像マッチングが必須です。プレイヤー名ではキャラを判別できません。

## まとめ

1. **戦績画面のスクショを用意**
2. **`python extract_icons.py screenshot.png` で自動切り出し**
3. **よく使うキャラから登録**
4. **Botを起動して確認**

これで準備完了です！

## セットアップ（任意）

### 1. templatesディレクトリを作成

```bash
mkdir -p templates/icons
```

### 2. キャラアイコン画像を用意

各キャラクターのアイコン画像（PNG形式推奨）を以下の命名規則で保存：

```
templates/icons/
├── 花香芽矢.png
├── ヘドウィグ.png
├── にゃお.png
├── 永眠者.png
├── 医師.png
├── 庭師.png
└── ...
```

### 3. アイコン画像の作成方法

#### 方法A: ゲームから切り出し
1. 戦績画面のスクショを撮る
2. 画像編集ソフトで各キャラのアイコン部分を切り出し
3. サイズを統一（推奨: 80x80 ピクセル）
4. PNG形式で保存

#### 方法B: 公式素材を使用
- 第五人格の公式サイトやWikiからアイコン画像をダウンロード
- サイズを統一して保存

### 4. アイコン画像の推奨仕様

```
形式: PNG
サイズ: 80x80 px
背景: 透明または単色
品質: できるだけ鮮明
```

## 動作確認

キャラアイコンを追加後、Botを起動すると：

```
✅ 35個のキャラアイコンを読み込みました
```

このようなメッセージが表示されます。

## 画像認識の仕組み

```python
# 1. テキストOCRでキャラ名を探す
if "花香芽矢" in text:
    character = "花香芽矢"

# 2. 見つからない場合、画像マッチング
if not character:
    # アイコン領域を切り出し
    icon = img[y1:y2, x1:x2]
    
    # 各テンプレートと照合
    for template_name, template_img in templates:
        similarity = compare(icon, template_img)
        if similarity > 0.6:  # 60%以上一致
            character = template_name
```

## テンプレート画像の例

実際の戦績画面から切り出したアイコン例：

```
┌────────┐
│  👤   │  ← このアイコン部分を切り出す
│  花香  │
└────────┘
```

切り出し位置：
- X座標: 左から約50-130px
- Y座標: 各サバイバーの行（4行分）
- サイズ: 約80x80px

## トラブルシューティング

### アイコンが認識されない

**原因1: テンプレート画像のサイズが合っていない**
→ 80x80pxに統一

**原因2: ゲーム画面の解像度が異なる**
→ 異なる解像度でもう一度切り出す

**原因3: アイコンの表示が変わった（アップデート等）**
→ 最新のスクショから再度切り出す

### 認識精度を上げる方法

1. **複数サイズのテンプレートを用意**
   ```
   templates/icons/
   ├── 花香芽矢_80.png
   ├── 花香芽矢_100.png
   └── 花香芽矢_120.png
   ```

2. **異なる状態のアイコンを用意**
   - 通常状態
   - 選択状態
   - ダウン状態

3. **閾値を調整**
   ```python
   # ocr_processor.py の best_score を調整
   best_score = 0.5  # 50%以上で認識（緩和）
   best_score = 0.7  # 70%以上で認識（厳格）
   ```

## テキストOCRのみで使用する場合

画像マッチングを使わない場合は、`templates/icons/` ディレクトリを作成しなくてもOKです。テキストOCRのみで動作します。

```
✅ 0個のキャラアイコンを読み込みました
→ テキストOCRのみで動作
```

これでもほとんどの場合は問題なく認識できます。

## まとめ

- **基本**: テキストOCRのみで十分（画像不要）
- **強化**: アイコン画像を追加すると認識率UP
- **推奨**: まずはテキストOCRで試して、必要に応じて画像追加

実際に使ってみて、認識率が低い場合のみアイコン画像を追加するのがおすすめです。
